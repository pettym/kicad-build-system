name: "Kicad"

on:
  workflow_call:
    inputs:
      tags:

  push:
    paths:
      - '**/*' # TODO: remove this
      - '**/*.kicad*'
      - '**/*.kibot.yaml'
      - '**/kibot-ci.yml'
    tags:
      - '*'
    branches-ignore:
      - 'master'
      - 'main'

env:
  FULL_VERSION_ID: ${{github.event.repository.name}}-${{github.sha}}-${{github.ref_name}}
  GERBER_FILE_JLCPCB: ${{github.event.repository.name}}-${{github.sha}}-${{github.ref_name}}-gerber-jlcpcb.zip
      
jobs:
  KiBot:
    runs-on: ubuntu-latest
    container: ghcr.io/inti-cmnb/kicad6_auto_full:1.6.3
    steps:

    - name: checkout kidcad-build-system
      uses: actions/checkout@v4
      with:
        repository: pettym/kicad-build-system
        ref: "build-system"
        path: "../kicad-build-system"
      
    - name: checkout repo
      uses: actions/checkout@v4

    - name: DEBUG
      run: >-
        pwd ~/ && ls ~/

    - name: KiBot Example Config
      run: >-
        kibot --example &&
        mkdir build &&
        mv example* build/.
        
    - name: KiBot
      run: >-
        kibot
        --plot-config ../kicad-build-system/kibot/config.kibot.yaml
        --out-dir build
        --no-auto-download

    # - name: Upload Artifacts
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: artifacts-${{github.sha}}-${{github.ref_name}}
    #     path: ./build
    #     if-no-files-found: error
        
    # - name: Build Tagged Release
    #   uses: softprops/action-gh-release@v1
    #   if: startsWith(github.ref, 'refs/tags/')
    #   with:
    #     tag_name: ${{ github.ref_name }}
    #     files: |
    #       ./build/gerber-files/${{ env.GERBER_FILE_JLCPCB }}
    #       ./build/thumbnails/front.png
    #       ./build/thumbnails/back.png
    #     body: |
    #       ![Front](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/front.png)
    #       ![Back](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/back.png)

